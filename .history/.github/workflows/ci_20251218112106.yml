# MediaForge CI Pipeline
# Comprehensive testing, linting, and code quality checks

name: CI Pipeline

on:
    push:
        branches: [main, develop]
        paths-ignore:
            - "**.md"
            - "docs/**"
            - ".github/*.md"
    pull_request:
        branches: [main, develop]
        paths-ignore:
            - "**.md"
            - "docs/**"
            - ".github/*.md"
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    PYTHON_VERSION: "3.11"
    COVERAGE_THRESHOLD: 70

jobs:
    # ============================================
    # Code Quality Checks (Fast Feedback)
    # ============================================
    quality-checks:
        name: Code Quality
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                python-version: ["3.11", "3.12"]

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e . 2>/dev/null || true
                  pip install black flake8 flake8-docstrings flake8-bugbear mypy isort

            - name: Format check (black)
              run: black --check --diff --color src/ tests/

            - name: Import sort check (isort)
              run: isort --check-only --diff src/ tests/

            - name: Lint (flake8)
              run: |
                  flake8 src/ tests/ --count --statistics \
                      --max-line-length=88 \
                      --extend-ignore=E203,W503,D100,D101,D102,D103,D104,D105,D107 \
                      --show-source

            - name: Type check (mypy)
              run: |
                  pip install -r requirements.txt
                  mypy src/ \
                      --python-version 3.11 \
                      --ignore-missing-imports \
                      --show-error-codes \
                      --pretty

    test:
        name: Test Suite
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: ["3.11", "3.12"]

        services:
            # Optional: Add services if needed in future (PostgreSQL, Redis, etc.)

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v4
              with:
                  python-version: ${{ matrix.python-version }}
                  cache: "pip"

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y ffmpeg libmagic1

            - name: Install Python dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e .
                  pip install pytest pytest-asyncio pytest-cov

            - name: Run unit tests
              run: |
                  pytest tests/unit -v --cov=src --cov-report=xml --cov-report=term-missing

            - name: Run integration tests
              run: |
                  pytest tests/integration -v --cov=src --cov-append --cov-report=xml --cov-report=term-missing

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v3
              with:
                  file: ./coverage.xml
                  flags: unittests
                  name: codecov-umbrella
                  fail_ci_if_error: false
              continue-on-error: true

    security:
        name: Security Checks
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install bandit safety

            - name: Bandit security scan
              run: bandit -r src -f json -o bandit-report.json
              continue-on-error: true

            - name: Safety check dependencies
              run: safety check --json
              continue-on-error: true

    build:
        name: Build Docker Image
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        needs: [quality-checks, test, security]

        permissions:
            contents: read
            packages: write

        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v2
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v4
              with:
                  images: ghcr.io/${{ github.repository }}
                  tags: |
                      type=ref,event=branch
                      type=sha,prefix={{branch}}-
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Build and push Docker image
              uses: docker/build-push-action@v4
              with:
                  context: .
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=registry,ref=ghcr.io/${{ github.repository }}:buildcache
                  cache-to: type=registry,ref=ghcr.io/${{ github.repository }}:buildcache,mode=max

    summary:
        name: CI Summary
        runs-on: ubuntu-latest
        if: always()
        needs: [quality-checks, test, security, build]

        steps:
            - name: Check CI Status
              run: |
                  if [[ "${{ needs.quality-checks.result }}" == "failure" || \
                        "${{ needs.test.result }}" == "failure" || \
                        "${{ needs.security.result }}" == "failure" ]]; then
                    echo "❌ CI pipeline failed"
                    exit 1
                  fi
                  echo "✅ CI pipeline passed"
