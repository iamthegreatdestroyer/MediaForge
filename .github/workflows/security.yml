name: Security Scanning

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    schedule:
        - cron: "0 0 * * 0" # Weekly on Sunday

jobs:
    dependency-check:
        name: Dependency Vulnerability Scan
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Install scanning tools
              run: |
                  pip install --upgrade pip
                  pip install safety bandit pip-audit

            - name: Run Safety check
              run: safety check --json --output safety-report.json
              continue-on-error: true

            - name: Run pip-audit
              run: pip-audit --desc
              continue-on-error: true

            - name: Upload safety report
              uses: actions/upload-artifact@v3
              with:
                  name: safety-report
                  path: safety-report.json
              if: always()

    sast:
        name: SAST - Static Application Security Testing
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Install dependencies
              run: |
                  pip install --upgrade pip
                  pip install bandit semgrep

            - name: Bandit SAST scan
              run: bandit -r src -f json -o bandit-report.json
              continue-on-error: true

            - name: Semgrep SAST scan
              uses: returntocorp/semgrep-action@v1
              with:
                  config: >-
                      p/security-audit
                      p/owasp-top-ten
                      p/python
              continue-on-error: true

            - name: Upload Bandit report
              uses: actions/upload-artifact@v3
              with:
                  name: bandit-report
                  path: bandit-report.json
              if: always()

    container-scan:
        name: Container Image Scan
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        permissions:
            contents: read
            packages: write

        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Build Docker image
              uses: docker/build-push-action@v4
              with:
                  context: .
                  push: false
                  load: true
                  tags: mediaforge:scan

            - name: Run Trivy container scan
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: mediaforge:scan
                  format: "sarif"
                  output: "trivy-results.sarif"
                  severity: "HIGH,CRITICAL"
              continue-on-error: true

            - name: Upload Trivy results
              uses: github/codeql-action/upload-sarif@v2
              with:
                  sarif_file: "trivy-results.sarif"
                  category: "trivy-container"
              if: always()
              continue-on-error: true

    secrets-scan:
        name: Secrets Detection
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: TruffleHog Secret Scan
              uses: trufflesecurity/trufflehog@main
              with:
                  path: ./
                  base: ${{ github.event.repository.default_branch }}
                  head: HEAD
                  extra_args: --debug --only-verified
              continue-on-error: true

            - name: GitGuardian scan
              uses: GitGuardian/ggshield-action@master
              env:
                  GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
              with:
                  scan-option: --all-history
              continue-on-error: true

    code-quality:
        name: Code Quality Analysis
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install pylint black isort mypy flake8

            - name: pylint scan
              run: pylint src --exit-zero --output-format=text
              continue-on-error: true

            - name: MyPy type checking
              run: mypy src --ignore-missing-imports --junit-xml=mypy-report.xml
              continue-on-error: true

            - name: Upload MyPy report
              uses: actions/upload-artifact@v3
              with:
                  name: mypy-report
                  path: mypy-report.xml
              if: always()

    summary:
        name: Security Summary
        runs-on: ubuntu-latest
        if: always()
        needs:
            [dependency-check, sast, container-scan, secrets-scan, code-quality]

        steps:
            - name: Security Check Summary
              run: |
                  echo "## ðŸ”’ Security Scanning Complete"
                  echo ""
                  echo "âœ… Dependency vulnerabilities checked"
                  echo "âœ… Static application security testing (SAST) completed"
                  echo "âœ… Container image scanned"
                  echo "âœ… Secrets detection performed"
                  echo "âœ… Code quality analysis finished"
                  echo ""
                  echo "View detailed reports in the Artifacts section"
